// Generated by CoffeeScript 1.6.1
/*
Save article, triggle when click the save btn, or press Ctrl-S
@method saveArticle
*/

var adjustHeight, saveArticle;

saveArticle = function() {
  var article, articleId, completeNum, p, _i, _len, _ref;
  $('.save-state .state-waiting').show();
  $('.save-state .state-ok').hide();
  $('.save-state').animate({
    right: '32px'
  }, 200);
  article = {
    enTitle: $('.en-title').text(),
    cnTitle: $('.cn-title').text(),
    author: $('.author').val(),
    url: $('.url').val(),
    abstract: $('.abstract').val(),
    paraList: []
  };
  $('.para').each(function() {
    var cn, en, state, type;
    type = $(this).attr('data-type');
    if (type === 'image') {
      en = $(this).find('.en img').attr('src');
      cn = en;
    } else {
      en = $(this).find('.en').text().trim();
      cn = $(this).find('.cn').text().trim();
    }
    if ($(this).find('.ec-divider').attr('data-state') === 'true') {
      state = true;
    } else {
      state = false;
    }
    return article.paraList.push({
      en: en,
      cn: cn,
      type: type,
      state: state
    });
  });
  completeNum = 0;
  _ref = article.paraList;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    p = _ref[_i];
    if (p.state === true) {
      completeNum++;
    }
  }
  article.completion = (completeNum / article.paraList.length).toFixed(2);
  articleId = $('.title').data('article-id');
  return $.ajax({
    url: "/article/" + articleId + "/edit",
    method: 'POST',
    data: {
      article: article
    },
    success: function(data) {
      if (data.result === 1) {
        $('.save-state .state-waiting').hide();
        $('.save-state .state-ok').show();
        return setTimeout("$('.save-state').animate({right: '0px'}, 200)", 1000);
      }
    }
  });
};

/*
Dynamic change the height of the divider bar
@method adjustHeight
@param {DOM Div Element} para - the div element has class 'para'
*/


adjustHeight = function(para) {
  var cnHeight, dvHeight, enHeight;
  enHeight = para.find('.en').innerHeight();
  cnHeight = para.find('.cn').innerHeight();
  dvHeight = enHeight > cnHeight ? enHeight : cnHeight;
  return para.find('.ec-divider').css('height', dvHeight + 15 + 'px');
};

$(function() {
  var clickItem;
  $('.para').each(function() {
    return adjustHeight($(this));
  });
  $('.en, .cn').keyup(function() {
    return adjustHeight($(this).parent());
  });
  $('.en, .cn').blur(function() {
    return adjustHeight($(this).parent());
  });
  imagesLoaded($('.para')).on('progress', function(instance, image) {
    return adjustHeight($(image.img).parents('.para'));
  });
  $('.para').mouseover(function() {
    $('.focus-flag').css('visibility', 'hidden');
    return $(this).find('.focus-flag').css('visibility', 'visible');
  });
  $('.ec-divider').click(function() {
    if ($(this).attr('data-state') === 'false') {
      return $(this).attr('data-state', 'true');
    } else {
      return $(this).attr('data-state', 'false');
    }
  });
  $('.save-btn').click(saveArticle);
  $(document).keydown(function(e) {
    if (e.ctrlKey && e.which === 83) {
      e.preventDefault();
      return saveArticle();
    }
  });
  clickItem = null;
  $(document).on('contextmenu', '.para', function(e) {
    e.preventDefault();
    if ($(e.target).hasClass('para')) {
      clickItem = e.target;
    } else {
      clickItem = $(e.target).parents('.para').first()[0];
    }
    if ($(clickItem).attr('data-type') === 'image') {
      $('.context-menu').find('.only-for-text').hide();
    } else {
      $('.context-menu').find('.only-for-text').show();
    }
    return $('.context-menu').css({
      top: e.clientY + 2 + 'px',
      left: e.clientX + 2 + 'px',
      display: 'block'
    });
  });
  $(document).click(function() {
    return $('.context-menu').hide();
  });
  return $('.context-menu').click(function(e) {
    var c;
    c = $(e.target).attr('class');
    switch (c) {
      case 'mheader':
      case 'sheader':
      case 'text':
      case 'quote':
      case 'code':
        $(clickItem).attr('data-type', c);
        return adjustHeight($(clickItem));
      case 'add-para':
        $(clickItem).after("<textarea class='add-content-wap' placeholder='文本 / 图片地址' rows=4></textarea>");
        return $('.add-content-wap').focus().blur(function() {
          var addContent;
          addContent = $(this).val().trim();
          if (addContent !== "") {
            if (addContent.match(/\b(http:\/\/)/) && addContent.match(/.(gif|png|jpeg|jpg|bmp)\b/)) {
              $(clickItem).after("<div data-type='image' class='para clearfix'>\n  <div class='en'>\n    <img src='" + addContent + "' /></div\n  ><div class='ec-divider' data-state='true'></div\n  ><div class='cn'>\n    <img src='" + addContent + "' />\n  </div>\n</div>");
              imagesLoaded($(clickItem).next(), function() {
                return adjustHeight($(clickItem).next());
              });
            } else {
              $(clickItem).after("<div data-type='text' class='para clearfix'>\n  <div class='en' contenteditable='true'>" + addContent + "</div\n  ><div class='ec-divider'></div\n  ><div class='cn' contenteditable='true'></div>\n</div>");
              adjustHeight($(clickItem).next());
            }
          }
          $(this).detach();
          return adjustHeight($(clickItem).next());
        });
      case 'remove-para':
        return $(clickItem).detach();
    }
  });
});
